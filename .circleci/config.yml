# CircleCI Configuration para √Årboles Info Maps
version: 2.1

# Orbs para reutilizar configuraciones comunes
orbs:
  docker: circleci/docker@2.2.0

# Jobs
jobs:
  # Job: Tests y Linting
  test:
    docker:
      - image: cimg/python:3.13
    working_directory: ~/project
    steps:
      - checkout
      
      # Verificar que el tag est√° en la rama main
      - run:
          name: Verificar que el tag est√° en main
          command: |
            if [ -n "${CIRCLE_TAG}" ]; then
              echo "Tag detectado: ${CIRCLE_TAG}"
              # Verificar que el commit del tag est√° en main
              git fetch origin main || true
              if git branch -r --contains $(git rev-parse ${CIRCLE_TAG}) | grep -q "origin/main"; then
                echo "‚úÖ El tag ${CIRCLE_TAG} est√° en la rama main"
              else
                echo "‚ùå El tag ${CIRCLE_TAG} NO est√° en la rama main. Abortando."
                exit 1
              fi
            else
              echo "‚ö†Ô∏è  No se detect√≥ un tag, continuando..."
            fi
      
      # Restaurar cache de pip
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "requirements.txt" }}
            - v1-dependencies-
      
      # Instalar dependencias
      - run:
          name: Instalar dependencias
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            pip install flake8 black isort
      
      # Guardar cache de pip
      - save_cache:
          paths:
            - venv
          key: v1-dependencies-{{ checksum "requirements.txt" }}
      
      # Ejecutar linting
      - run:
          name: Linting con flake8
          command: |
            . venv/bin/activate
            flake8 maps/ arboles_info_project/ --max-line-length=100 --ignore=E203,W503 --count --statistics || true
      
      - run:
          name: Verificar imports con isort
          command: |
            . venv/bin/activate
            isort maps/ arboles_info_project/ --check-only --diff || true
      
      # Ejecutar tests de Django
      - run:
          name: Ejecutar tests Django
          command: |
            . venv/bin/activate
            python manage.py check
            python manage.py test --noinput || echo "No hay tests configurados"
      
      # Verificar que collectstatic funciona
      - run:
          name: Verificar collectstatic
          command: |
            . venv/bin/activate
            python manage.py collectstatic --noinput --dry-run

  # Job: Build Docker Image
  build-docker:
    docker:
      - image: cimg/base:current
    working_directory: ~/project
    steps:
      - checkout
      
      # Verificar que el tag est√° en la rama main
      - run:
          name: Verificar que el tag est√° en main
          command: |
            if [ -n "${CIRCLE_TAG}" ]; then
              echo "Tag detectado: ${CIRCLE_TAG}"
              # Verificar que el commit del tag est√° en main
              git fetch origin main || true
              if git branch -r --contains $(git rev-parse ${CIRCLE_TAG}) | grep -q "origin/main"; then
                echo "‚úÖ El tag ${CIRCLE_TAG} est√° en la rama main"
              else
                echo "‚ùå El tag ${CIRCLE_TAG} NO est√° en la rama main. Abortando."
                exit 1
              fi
            else
              echo "‚ö†Ô∏è  No se detect√≥ un tag, continuando..."
            fi
      
      # Setup Docker Buildx (necesario para construir im√°genes Docker)
      - setup_remote_docker:
          version: 24.0.5
      
      # Instalar make si no est√° disponible
      - run:
          name: Verificar make
          command: |
            if ! command -v make &> /dev/null; then
              echo "Instalando make..."
              sudo apt-get update && sudo apt-get install -y make
            fi
            make --version
      
      # Build Docker image usando make
      - run:
          name: Build Docker image
          command: |
            # Usar el tag de git si existe, sino usar el SHA
            if [ -n "${CIRCLE_TAG}" ]; then
              echo "üè∑Ô∏è  Usando tag de git: ${CIRCLE_TAG}"
              make docker-build-ci CIRCLE_SHA1=${CIRCLE_SHA1} DOCKER_TAG=${CIRCLE_TAG}
            else
              echo "üîñ Usando SHA: ${CIRCLE_SHA1}"
              make docker-build-ci CIRCLE_SHA1=${CIRCLE_SHA1}
            fi
      
      # Test Docker image usando make
      - run:
          name: Test Docker image
          command: |
            make docker-test
      
      # Login al DigitalOcean Container Registry
      - run:
          name: Login al DigitalOcean Container Registry
          command: |
            if [ -z "${DO_REGISTRY_TOKEN}" ]; then
              echo "‚ö†Ô∏è  Variable DO_REGISTRY_TOKEN no configurada. Saltando push al registry."
              echo "üí° Configura DO_REGISTRY_TOKEN en CircleCI (Settings ‚Üí Environment Variables)"
              echo "üí° Para obtener el token: doctl registry login o crea un token en DigitalOcean"
              exit 0
            fi
            echo "üîê Autenticando en DigitalOcean Container Registry..."
            echo "${DO_REGISTRY_TOKEN}" | docker login registry.digitalocean.com -u "${DO_REGISTRY_TOKEN}" --password-stdin
      
      # Taggear imagen para DigitalOcean Container Registry
      - run:
          name: Taggear imagen para DigitalOcean Registry
          command: |
            if [ -z "${DO_REGISTRY_TOKEN}" ]; then
              echo "‚ö†Ô∏è  Variable DO_REGISTRY_TOKEN no configurada. Saltando tag."
              exit 0
            fi
            REGISTRY="registry.digitalocean.com"
            REGISTRY_NAME="${DO_REGISTRY_NAME:-arboles-info}"
            IMAGE_NAME="${DO_IMAGE_NAME:-arboles-info-maps}"
            FULL_IMAGE="${REGISTRY}/${REGISTRY_NAME}/${IMAGE_NAME}"
            echo "üè∑Ô∏è  Taggeando imagen para: ${FULL_IMAGE}"
            # Usar el tag de git si existe, sino usar SHA
            if [ -n "${CIRCLE_TAG}" ]; then
              echo "üè∑Ô∏è  Usando tag de git: ${CIRCLE_TAG}"
              docker tag arboles-info-maps:${CIRCLE_TAG} ${FULL_IMAGE}:${CIRCLE_TAG}
              docker tag arboles-info-maps:${CIRCLE_TAG} ${FULL_IMAGE}:latest
              docker tag arboles-info-maps:${CIRCLE_TAG} ${FULL_IMAGE}:${CIRCLE_SHA1}
            else
              echo "üîñ Usando SHA: ${CIRCLE_SHA1}"
              docker tag arboles-info-maps:${CIRCLE_SHA1} ${FULL_IMAGE}:${CIRCLE_SHA1}
              docker tag arboles-info-maps:${CIRCLE_SHA1} ${FULL_IMAGE}:latest
            fi
      
      # Pushear imagen al DigitalOcean Container Registry
      - run:
          name: Pushear imagen al DigitalOcean Registry
          command: |
            if [ -z "${DO_REGISTRY_TOKEN}" ]; then
              echo "‚ö†Ô∏è  Variable DO_REGISTRY_TOKEN no configurada. Saltando push."
              exit 0
            fi
            REGISTRY="registry.digitalocean.com"
            REGISTRY_NAME="${DO_REGISTRY_NAME:-arboles-info}"
            IMAGE_NAME="${DO_IMAGE_NAME:-arboles-info-maps}"
            FULL_IMAGE="${REGISTRY}/${REGISTRY_NAME}/${IMAGE_NAME}"
            echo "üì§ Pusheando imagen a: ${FULL_IMAGE}"
            # Priorizar el tag de git si existe
            if [ -n "${CIRCLE_TAG}" ]; then
              echo "üì§ Pusheando tag de git: ${CIRCLE_TAG}"
              docker push ${FULL_IMAGE}:${CIRCLE_TAG} || (echo "‚ö†Ô∏è  Error pusheando tag ${CIRCLE_TAG}" && exit 1)
              docker push ${FULL_IMAGE}:latest || (echo "‚ö†Ô∏è  Error pusheando latest" && exit 1)
              docker push ${FULL_IMAGE}:${CIRCLE_SHA1} || (echo "‚ö†Ô∏è  Error pusheando SHA ${CIRCLE_SHA1}" && exit 1)
            else
              echo "üì§ Pusheando SHA: ${CIRCLE_SHA1}"
              docker push ${FULL_IMAGE}:${CIRCLE_SHA1} || (echo "‚ö†Ô∏è  Error pusheando SHA ${CIRCLE_SHA1}" && exit 1)
              docker push ${FULL_IMAGE}:latest || (echo "‚ö†Ô∏è  Error pusheando latest" && exit 1)
            fi
            echo "‚úÖ Imagen pusheada exitosamente a DigitalOcean Container Registry"
            echo "üì¶ Imagen disponible en: ${FULL_IMAGE}"

  # Job: Security Checks (opcional)
  security:
    docker:
      - image: cimg/python:3.13
    working_directory: ~/project
    steps:
      - checkout
      
      # Verificar que el tag est√° en la rama main
      - run:
          name: Verificar que el tag est√° en main
          command: |
            if [ -n "${CIRCLE_TAG}" ]; then
              echo "Tag detectado: ${CIRCLE_TAG}"
              # Verificar que el commit del tag est√° en main
              git fetch origin main || true
              if git branch -r --contains $(git rev-parse ${CIRCLE_TAG}) | grep -q "origin/main"; then
                echo "‚úÖ El tag ${CIRCLE_TAG} est√° en la rama main"
              else
                echo "‚ùå El tag ${CIRCLE_TAG} NO est√° en la rama main. Abortando."
                exit 1
              fi
            else
              echo "‚ö†Ô∏è  No se detect√≥ un tag, continuando..."
            fi
      
      - run:
          name: Instalar dependencias
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install safety bandit
      
      - run:
          name: Verificar dependencias con Safety
          command: |
            . venv/bin/activate
            safety check -r requirements.txt || echo "Advertencias de seguridad encontradas"
      
      - run:
          name: An√°lisis est√°tico con Bandit
          command: |
            . venv/bin/activate
            bandit -r maps/ arboles_info_project/ -f json -o bandit-report.json || true

# Workflows
workflows:
  # Workflow principal: se ejecuta solo cuando se hace push de un tag
  # La verificaci√≥n de que el tag est√° en main se hace en cada job
  main:
    jobs:
      - test
      - build-docker
      - security
    filters:
      tags:
        only: /.*/
      branches:
        ignore: /.*/

  # Workflow para PRs: solo tests y linting
  pull-request:
    jobs:
      - test
      - build-docker
