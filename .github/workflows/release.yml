name: Release

on:
  push:
    branches:
      - main

jobs:
  validate-and-tag:
    name: Validate Commit and Create Tag with Commitizen
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # Necesario para obtener el historial completo de commits
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Skip if bump commit or [skip ci]
      id: skip
      run: |
        COMMIT_MSG=$(git log -1 --pretty=%B)
        if echo "$COMMIT_MSG" | grep -qE '^chore\(release\):.*bump version|\[skip ci\]|\[ci skip\]'; then
          echo "‚è≠Ô∏è Commit de bump de versi√≥n o [skip ci] detectado, saltando workflow"
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "skip=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Set up Python
      if: steps.skip.outputs.skip != 'true'
      uses: actions/setup-python@v6
      with:
        python-version: '3.13'
    
    - name: Install Commitizen
      if: steps.skip.outputs.skip != 'true'
      run: |
        python -m pip install --upgrade pip
        pip install commitizen
    
    - name: Validate commit message
      if: steps.skip.outputs.skip != 'true'
      id: validate
      run: |
        COMMIT_MSG=$(git log -1 --pretty=%B)
        echo "Validando commit message: $COMMIT_MSG"
        
        # Crear archivo temporal con el mensaje del commit
        echo "$COMMIT_MSG" > /tmp/commit_msg.txt
        
        # Validar el √∫ltimo commit usando commitizen
        cz check --commit-msg-file /tmp/commit_msg.txt || {
          echo "‚ùå Commit message no sigue Conventional Commits"
          echo "Formato esperado: <type>(<scope>): <subject>"
          echo "Tipos v√°lidos: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
          echo "Ejemplo: feat(api): add new endpoint"
          exit 1
        }
        
        echo "‚úÖ Commit message v√°lido"
        echo "valid=true" >> $GITHUB_OUTPUT
    
    - name: Get current version
      if: steps.skip.outputs.skip != 'true'
      id: current_version
      run: |
        # Obtener el √∫ltimo tag sem√°ntico
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
        echo "Last tag: $LAST_TAG"
        echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
    
    - name: Bump version and create tag
      if: steps.skip.outputs.skip != 'true'
      id: bump
      run: |
        # Configurar git para commits
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Verificar si hay tags existentes
        if ! git describe --tags --abbrev=0 >/dev/null 2>&1; then
          echo "No hay tags existentes, creando tag inicial v0.0.0..."
          # Crear tag inicial en el primer commit
          FIRST_COMMIT=$(git rev-list --max-parents=0 HEAD)
          git tag -a "v0.0.0" -m "chore(release): initial version" "$FIRST_COMMIT"
          git push origin "v0.0.0"
          echo "Tag inicial v0.0.0 creado"
        fi
        
        # Obtener versi√≥n actual antes del bump
        OLD_VERSION=$(cz version --project 2>/dev/null || echo "0.0.0")
        echo "Versi√≥n actual: $OLD_VERSION"
        echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
        
        # Ejecutar bump de versi√≥n
        # --yes para no interactuar, --changelog para generar changelog
        cz bump --yes --changelog || {
          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 3 ]; then
            echo "‚ö†Ô∏è No hay cambios que requieran bump de versi√≥n"
            echo "bumped=false" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "‚ùå Error al hacer bump de versi√≥n"
            exit $EXIT_CODE
          fi
        }
        
        # Obtener nueva versi√≥n
        NEW_VERSION=$(cz version --project)
        NEW_TAG="v$NEW_VERSION"
        
        echo "Nueva versi√≥n: $NEW_VERSION"
        echo "Nuevo tag: $NEW_TAG"
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
        echo "bumped=true" >> $GITHUB_OUTPUT
    
    - name: Push tag and changes
      if: steps.bump.outputs.bumped == 'true' && steps.skip.outputs.skip != 'true'
      run: |
        NEW_TAG="${{ steps.bump.outputs.new_tag }}"
        
        # Pushear el tag (esto funciona porque los tags no est√°n protegidos)
        echo "Pusheando tag $NEW_TAG..."
        git push origin "$NEW_TAG"
        
        # Intentar pushear el commit de bump de versi√≥n
        # Nota: Esto puede fallar si la rama est√° protegida, pero el tag ya est√° pusheado
        if [ "$(git rev-list --count HEAD ^origin/main)" -gt 0 ]; then
          echo "Intentando pushear commit de bump de versi√≥n..."
          if git push origin main 2>&1; then
            echo "‚úÖ Commit de bump pusheado exitosamente"
          else
            echo "‚ö†Ô∏è No se pudo pushear el commit de bump (rama protegida)"
            echo "El tag $NEW_TAG fue creado exitosamente, pero el commit de bump no se pudo pushear."
            echo "Para resolver esto:"
            echo "1. Configura un Personal Access Token (PAT) con permisos de escritura"
            echo "2. O permite que 'github-actions[bot]' haga bypass en las reglas de protecci√≥n"
            echo "3. O haz push manual del commit de bump desde tu m√°quina local"
          fi
        fi
        
        echo "‚úÖ Tag $NEW_TAG creado y pusheado exitosamente"
    
    - name: Summary
      if: always()
      run: |
        echo "## üìã Resumen de Release" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **√öltimo tag anterior**: ${{ steps.current_version.outputs.last_tag }}" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.bump.outputs.bumped }}" == "true" ]; then
          echo "- **Nueva versi√≥n**: ${{ steps.bump.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Nuevo tag**: ${{ steps.bump.outputs.new_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Estado**: ‚úÖ Versi√≥n actualizada y tag creado exitosamente" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Estado**: ‚ÑπÔ∏è No se requiri√≥ bump de versi√≥n" >> $GITHUB_STEP_SUMMARY
        fi

